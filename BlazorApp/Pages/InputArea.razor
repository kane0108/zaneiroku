@inject IJSRuntime JS

<div id="inputArea"
     @onmousedown="OnMouseDown"
     @onmouseup="OnMouseUp"
     @ontouchstart="OnTouchStart"
     @ontouchend="OnTouchEnd"
     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; touch-action: none;">
</div>

@code {
    private Game.GameObjectBase? gestureCaptured;
    private float gestureStartX, gestureStartY;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("preventTouchDefaults", "inputArea");
        }
    }

    private async Task OnMouseDown(MouseEventArgs e)
    {
        var p = await JS.InvokeAsync<CanvasPoint>(
                "getCanvasPointerPosition", "gameCanvas",
                (float)e.ClientX, (float)e.ClientY);

        await OnPointerDownInternal((float)p.X, (float)p.Y);
    }

    private async Task OnMouseUp(MouseEventArgs e)
    {
        var p = await JS.InvokeAsync<CanvasPoint>("getCanvasPointerPosition", "gameCanvas", (float)e.ClientX, (float)e.ClientY);
        await OnPointerUpInternal((float)p.X, (float)p.Y);
    }

    private async Task OnTouchStart(TouchEventArgs e)
    {
        if (e.Touches.Length == 0) return;
        var t = e.Touches[0];
        var p = await JS.InvokeAsync<CanvasPoint>(
            "getCanvasPointerPosition", "gameCanvas",
            (float)t.ClientX, (float)t.ClientY);

        await OnPointerDownInternal((float)p.X, (float)p.Y);
    }

    private async Task OnTouchEnd(TouchEventArgs e)
    {
        if (e.ChangedTouches.Length == 0) return;
        var t = e.ChangedTouches[0];
        var p = await JS.InvokeAsync<CanvasPoint>("getCanvasPointerPosition", "gameCanvas", (float)t.ClientX, (float)t.ClientY);
        await OnPointerUpInternal((float)p.X, (float)p.Y);
    }

    private async Task OnPointerDownInternal(float x, float y)
    {
        gestureStartX = x;
        gestureStartY = y;

        var scene = Game.GameMain.Instance.CurrentScene;
        if (scene == null) return;

        // --- UIは矩形判定のままキャプチャ
        var ui = Game.GameMain.GetHitUI(scene, x, y);
        if (ui != null)
        {
            gestureCaptured = ui;

            // ★ 長押し準備
            ui._isPressing = true;
            ui._pressTimer = 0f;
            ui._longPressTriggered = false;
            return;
        }

        // キャラはキャプチャ不要（キャラにスワイプ操作はしない想定）
        gestureCaptured = null;
    }

    private async Task OnPointerUpInternal(float x, float y)
    {
        float dx = x - gestureStartX;
        float dy = y - gestureStartY;
        float distance = MathF.Sqrt(dx * dx + dy * dy);

        var scene = Game.GameMain.Instance.CurrentScene;
        if (scene == null) return;

        if (gestureCaptured is Game.UIObject ui)
        {
            // --- 長押し状態で離した場合 ---
            if (ui._longPressTriggered)
            {
                ui.OnLongPressRelease?.Invoke();
            }
            else if (distance < 10f)
            {
                // --- 短押し（クリック扱い） ---
                ui.OnClick?.Invoke();
            }
            else
            {
                // --- スワイプ処理 ---
                var dir = MathF.Abs(dx) > MathF.Abs(dy)
                    ? (dx > 0 ? "右" : "左")
                    : (dy > 0 ? "下" : "上");

                ui.OnSwipe?.Invoke(dir);
            }

            // 状態リセット
            ui._isPressing = false;
            ui._pressTimer = 0f;
            ui._longPressTriggered = false;
            gestureCaptured = null;
            return;
        }

        // --- UIにヒットしなかった場合 ---

        if (distance < 10f)
        {
            // 1) キャラ（矩形候補 → Precise判定）
            foreach (var ch in Game.GameMain.GetHitCharacterRough(scene, x, y))
            {
                if (await ch.IsHitPreciseAsync(x, y, JS))
                {
                    ch.OnClick?.Invoke();
                    return;
                }
            }

            // 2) シーン固有
            (scene as Game.Battle.BattleScene)?.OnTapInBattle(x, y);
        }
        else
        {
            // --- シーン全体スワイプ ---
            var dir = MathF.Abs(dx) > MathF.Abs(dy)
                ? (dx > 0 ? "右" : "左")
                : (dy > 0 ? "下" : "上");

            Game.GameMain.Instance.OnSwipe(dir);
        }

        gestureCaptured = null;
    }

    public class CanvasPoint
    {
        public double X { get; set; }
        public double Y { get; set; }
    }
}
